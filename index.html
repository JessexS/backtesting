<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Backtest Engine — Live Market Simulator</title>
<link rel="stylesheet" href="css/styles.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<div class="shell" id="shell">

  <header class="topbar">
    <div class="logo">
      <div class="logo-dot" id="dot"></div>
      BACKTEST ENGINE
      <span class="logo-sub">// Live Simulator</span>
    </div>
    <div class="vdiv desktop-only"></div>
    <div class="ticker desktop-only">
      <div class="tick-item"><span class="tick-label">PRICE</span>  <span class="tick-val" id="tkP">—</span></div>
      <div class="tick-item"><span class="tick-label">CHG</span>    <span class="tick-val" id="tkC">—</span></div>
      <div class="tick-item"><span class="tick-label">HIGH</span>   <span class="tick-val" id="tkH">—</span></div>
      <div class="tick-item"><span class="tick-label">LOW</span>    <span class="tick-val" id="tkL">—</span></div>
      <div class="tick-item"><span class="tick-label">VOL</span>    <span class="tick-val" id="tkV">—</span></div>
      <div class="tick-item"><span class="tick-label">REGIME</span> <span class="tick-val" id="tkR">—</span></div>
      <div class="tick-item"><span class="tick-label">EQUITY</span> <span class="tick-val" id="tkEq">—</span></div>
    </div>
    <div class="topbar-right">
      <button class="btn btn-green" id="btnStart">&#9654; START</button>
      <button class="btn btn-yellow" id="btnPause" disabled>&#9208; PAUSE</button>
      <button class="btn btn-red" id="btnStop" disabled>&#9632; STOP</button>
      <div class="vdiv desktop-only"></div>
      <button class="btn btn-ghost" id="btnReset">&#10227; RESET</button>
    </div>
  </header>

  <!-- LEFT SIDEBAR -->
  <aside class="sidebar" id="sidebarLeft">
    <div class="panel">
      <div class="panel-title">Live Session</div>
      <div class="live-counter">
        <span class="lc-label">Kynttilät tallennettu</span>
        <span class="lc-val" id="liveCount">0</span>
      </div>
      <div class="panel-title" style="margin-bottom:6px">Nopeus</div>
      <div class="speed-grid" id="speedGrid">
        <div class="speed-btn" data-ms="2000">0.5×</div>
        <div class="speed-btn active" data-ms="800">1×</div>
        <div class="speed-btn" data-ms="250">3×</div>
        <div class="speed-btn" data-ms="60">15×</div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">Parametrit</div>
      <div class="control">
        <label title="Synteettisen markkinan aloitushinta. Tämä on ensimmäisen kynttilän hinta josta simulaatio alkaa.">Aloitushinta <span id="lbS">10 000</span></label>
        <input type="range" id="rS" min="100" max="100000" step="100" value="10000">
      </div>
      <div class="control">
        <label title="Perusvolatiliteetti (%). Määrittää kynttilöiden hintavaihtelun suuruuden. Matala arvo (0.3%) tuottaa pieniä kynttilöitä, korkea arvo (5%) suuria.">Volatiliteetti <span id="lbV">1.5%</span></label>
        <input type="range" id="rV" min="0.3" max="5" step="0.1" value="1.5">
      </div>
      <div class="control">
        <label title="Trendi-bias lisää jokaiseen kynttilään suuntaisen painotuksen. Positiivinen ylös, negatiivinen alas.">Trendi-bias <span id="lbB">0.00%</span></label>
        <input type="range" id="rB" min="-0.5" max="0.5" step="0.01" value="0">
      </div>
      <div class="control">
        <label title="Regiimin vaihtuvuustodennäköisyys (%). Matala = pitkät regiimit, korkea = tiheät vaihdot.">Regiimin vaihtuvuus <span id="lbSw">8%</span></label>
        <input type="range" id="rSw" min="1" max="30" step="1" value="8">
      </div>
      <div class="control">
        <label title="RNG-siemenluku (seed). Sama seed = identtinen hintapolku. Käytetään myös Monte Carlo -ajojen pohjana.">Seed <span id="lbSd">42</span></label>
        <input type="range" id="rSd" min="1" max="99999" step="1" value="42">
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">Regiiimit</div>
      <div class="regime-list">
        <div class="regime-item" id="ri-bull">     <div class="regime-dot" style="background:#26de81"></div><span class="regime-name">Bull Trend</span>  <span class="regime-pct" id="pct-bull">—</span></div>
        <div class="regime-item" id="ri-bear">     <div class="regime-dot" style="background:#fc5c65"></div><span class="regime-name">Bear Trend</span>  <span class="regime-pct" id="pct-bear">—</span></div>
        <div class="regime-item" id="ri-sideways"> <div class="regime-dot" style="background:#45aaf2"></div><span class="regime-name">Sideways</span>     <span class="regime-pct" id="pct-sideways">—</span></div>
        <div class="regime-item" id="ri-swing">    <div class="regime-dot" style="background:#fed330"></div><span class="regime-name">Swing</span>        <span class="regime-pct" id="pct-swing">—</span></div>
        <div class="regime-item" id="ri-breakout"> <div class="regime-dot" style="background:#fd9644"></div><span class="regime-name">Breakout</span>     <span class="regime-pct" id="pct-breakout">—</span></div>
        <div class="regime-item" id="ri-crash">    <div class="regime-dot" style="background:#a55eea"></div><span class="regime-name">Flash Crash</span> <span class="regime-pct" id="pct-crash">—</span></div>
      </div>
    </div>

    <div class="panel">
      <div class="panel-title">Statistiikka</div>
      <div class="stats-grid">
        <div class="stat"><div class="stat-label">Aloitus</div>     <div class="stat-value neu" id="stS">—</div></div>
        <div class="stat"><div class="stat-label">Nykyinen</div>    <div class="stat-value" id="stN">—</div></div>
        <div class="stat"><div class="stat-label">High</div>        <div class="stat-value up" id="stH">—</div></div>
        <div class="stat"><div class="stat-label">Low</div>         <div class="stat-value down" id="stL">—</div></div>
        <div class="stat"><div class="stat-label">Max Drawdown</div><div class="stat-value down" id="stDD">—</div></div>
        <div class="stat"><div class="stat-label">Tuotto</div>      <div class="stat-value" id="stRt">—</div></div>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main" id="mainArea">
    <div class="chart-toolbar">
      <span class="pair-badge">BTC/USDT</span>
      <span class="live-badge" id="liveBadge">LIVE</span>
      <div class="ind-legend" id="indLegend"></div>
      <span class="chart-hint desktop-only">Scroll = pan · Ctrl+Scroll = zoom · Drag = pan</span>
    </div>

    <div class="chart-area">
      <canvas id="cc"></canvas>
      <div class="nc-flash" id="ncf"></div>
      <div class="tooltip-box" id="tooltip">
        <div class="tt-row"><span class="tt-key">Aika</span>   <span class="tt-val" id="tta">—</span></div>
        <div class="tt-row"><span class="tt-key">Open</span>   <span class="tt-val" id="tto">—</span></div>
        <div class="tt-row"><span class="tt-key">High</span>   <span class="tt-val" id="tth">—</span></div>
        <div class="tt-row"><span class="tt-key">Low</span>    <span class="tt-val" id="ttl">—</span></div>
        <div class="tt-row"><span class="tt-key">Close</span>  <span class="tt-val" id="ttc">—</span></div>
        <div class="tt-row"><span class="tt-key">Chg%</span>   <span class="tt-val" id="ttchg">—</span></div>
        <div class="tt-row"><span class="tt-key">Volume</span> <span class="tt-val" id="ttv">—</span></div>
        <div class="tt-row"><span class="tt-key">Regime</span> <span class="tt-val" id="ttr">—</span></div>
      </div>
    </div>

    <div class="equity-area" id="eqArea" style="display:none">
      <canvas id="eqc"></canvas>
    </div>

    <div class="timeline-area">
      <div class="tl-label">Regiimi-aikajana</div>
      <div class="timeline-bar" id="tlBar"></div>
    </div>

    <div class="export-bar">
      <span class="export-info" id="expInfo">Paina <strong>&#9654; START</strong> aloittaaksesi live-datan tallennuksen.</span>
      <button class="btn btn-blue btn-sm" id="btnExportTrades" disabled>&#8595; TRADES CSV</button>
      <button class="btn btn-blue" id="btnExport" disabled>&#8595; EXPORTOI DATA</button>
    </div>
  </main>

  <!-- RIGHT SIDEBAR -->
  <aside class="sidebar-right" id="sidebarRight">
    <div class="panel">
      <div class="panel-title">Trading Mode</div>
      <div class="input-row">
        <div class="input-group">
          <label>Mode</label>
          <select id="tMode">
            <option value="spot">Spot</option>
            <option value="futures" selected>Futures (Isolated)</option>
          </select>
        </div>
        <div class="input-group">
          <label>Leverage</label>
          <select id="tLev">
            <option value="1">1×</option><option value="2">2×</option><option value="3">3×</option>
            <option value="5">5×</option><option value="10" selected>10×</option><option value="20">20×</option>
            <option value="25">25×</option><option value="40">40×</option>
          </select>
        </div>
      </div>
      <div class="input-row">
        <div class="input-group"><label>Maker Fee %</label><input type="number" id="tMakerFee" value="0.02" step="0.001" min="0"></div>
        <div class="input-group"><label>Taker Fee %</label><input type="number" id="tTakerFee" value="0.04" step="0.001" min="0"></div>
      </div>
      <div class="input-row">
        <div class="input-group"><label>Slippage %</label><input type="number" id="tSlippage" value="0.05" step="0.01" min="0"></div>
        <div class="input-group"><label>Maint. Rate %</label><input type="number" id="tMaintRate" value="0.5" step="0.1" min="0"></div>
      </div>
      <div class="input-row">
        <div class="input-group"><label>Starting Balance</label><input type="number" id="tBalance" value="10000" step="100" min="100"></div>
        <div class="input-group"><label>Position Sizing</label>
          <select id="tSizeMode"><option value="fixed">Fixed Amount</option><option value="percent">% of Equity</option></select>
        </div>
      </div>
      <div class="input-group"><label>Size Value</label><input type="number" id="tSizeVal" value="1000" step="100" min="1"></div>
      <div class="input-row" style="margin-top:4px">
        <div class="input-group"><label>Stop Loss %</label><input type="number" id="tSL" value="2" step="0.1" min="0"></div>
        <div class="input-group"><label>Take Profit %</label><input type="number" id="tTP" value="4" step="0.1" min="0"></div>
      </div>
      <div class="input-group"><label>Trailing Stop %</label><input type="number" id="tTrail" value="0" step="0.1" min="0"></div>
      <div class="input-group"><label>Partial Fill %</label><input type="number" id="tPartialFill" value="100" step="5" min="5" max="100"></div>
      <div class="trade-btns" id="manualTradeBtns">
        <button class="btn btn-green btn-sm" id="btnManualBuy">&#9650; BUY/LONG</button>
        <button class="btn btn-red btn-sm" id="btnManualSell">&#9660; SELL/SHORT</button>
      </div>
      <div class="trade-blocked" id="tradeBlockedMsg">Manuaalinen kaupankäynti estetty strategian ollessa aktiivinen</div>
    </div>

    <!-- Strategy Engine -->
    <div class="panel panel-collapse open" id="panelStrategy">
      <div class="panel-title">Strategy Engine</div>
      <div class="panel-body" id="strategyBody">
        <div class="toggle-row" style="margin-bottom:8px">
          <span>Enable Strategy</span>
          <label class="toggle"><input type="checkbox" id="tStratEnabled"><span class="toggle-slider"></span></label>
        </div>
        <div class="input-group">
          <label>Select Strategy</label>
          <select id="tStratSelect">
            <option value="custom">Custom (paste code)</option>
          </select>
        </div>
        <div id="stratParamsContainer"></div>
        <div class="input-group" style="margin-top:8px">
          <label>Strategy Code (JS)</label>
          <textarea id="tStratCode" rows="6" placeholder="// Select a preset strategy or paste custom code"></textarea>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn btn-blue btn-sm" id="btnLoadStrat">Load Strategy</button>
          <label class="btn btn-ghost btn-sm" style="display:inline-flex;align-items:center;cursor:pointer">
            Upload File <input type="file" accept=".js,.txt" style="display:none" id="btnUploadStrat">
          </label>
        </div>
        <div class="strat-error" id="stratError"></div>
      </div>
    </div>

    <!-- Positions -->
    <div class="panel panel-collapse open" id="panelPositions">
      <div class="panel-title">Open Positions <span id="posCount" style="color:var(--blue)">(0)</span></div>
      <div class="panel-body" id="positionsBody">
        <div class="pos-list" id="posList"></div>
      </div>
    </div>

    <!-- Performance -->
    <div class="panel panel-collapse open" id="panelPerformance">
      <div class="panel-title">Performance</div>
      <div class="panel-body" id="performanceBody">
        <div class="stats-grid" id="perfGrid">
          <div class="stat"><div class="stat-label">Balance</div><div class="stat-value sm neu" id="pmBal">—</div></div>
          <div class="stat"><div class="stat-label">Equity</div><div class="stat-value sm neu" id="pmEq">—</div></div>
          <div class="stat"><div class="stat-label">Unreal. PnL</div><div class="stat-value sm" id="pmUPnl">—</div></div>
          <div class="stat"><div class="stat-label">Real. PnL</div><div class="stat-value sm" id="pmRPnl">—</div></div>
          <div class="stat"><div class="stat-label">Win Rate</div><div class="stat-value sm" id="pmWR">—</div></div>
          <div class="stat"><div class="stat-label">Profit Factor</div><div class="stat-value sm" id="pmPF">—</div></div>
          <div class="stat"><div class="stat-label">Sharpe</div><div class="stat-value sm" id="pmSh">—</div></div>
          <div class="stat"><div class="stat-label">Max DD</div><div class="stat-value sm down" id="pmDD">—</div></div>
          <div class="stat"><div class="stat-label">Expectancy</div><div class="stat-value sm" id="pmExp">—</div></div>
          <div class="stat"><div class="stat-label">Kelly %</div><div class="stat-value sm" id="pmKe">—</div></div>
          <div class="stat"><div class="stat-label">Avg R</div><div class="stat-value sm" id="pmAvgR">—</div></div>
          <div class="stat"><div class="stat-label">Max Consec Loss</div><div class="stat-value sm down" id="pmMCL">—</div></div>
          <div class="stat"><div class="stat-label">Exposure %</div><div class="stat-value sm" id="pmExpo">—</div></div>
          <div class="stat"><div class="stat-label">Total Fees</div><div class="stat-value sm down" id="pmFees">—</div></div>
        </div>
      </div>
    </div>

    <!-- Trade Log -->
    <div class="panel panel-collapse" id="panelTradeLog">
      <div class="panel-title">Trade Log <span id="tradeCount" style="color:var(--blue)">(0)</span></div>
      <div class="panel-body" id="tradeLogBody">
        <div class="trade-log" id="tradeLog"></div>
      </div>
    </div>

    <!-- Monte Carlo -->
    <div class="panel panel-collapse" id="panelMonteCarlo">
      <div class="panel-title">Monte Carlo</div>
      <div class="panel-body" id="monteCarloBody">
        <div class="input-row">
          <div class="input-group"><label>Runs</label><input type="number" id="mcRuns" value="50" step="10" min="5" max="500"></div>
          <div class="input-group"><label>Candles/Run</label><input type="number" id="mcCandles" value="500" step="50" min="50" max="5000"></div>
        </div>
        <div class="input-group">
          <label>MC Mode</label>
          <select id="mcMode">
            <option value="seed">Seed Only</option>
            <option value="scramble">Parameter Scramble</option>
            <option value="combined">Combined Chaos</option>
            <option value="stress">Stress Test</option>
          </select>
        </div>
        <div class="input-group" id="mcChaosPresetGroup" style="display:none">
          <label>Chaos Preset</label>
          <select id="mcChaosPreset">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="extreme">Extreme</option>
          </select>
        </div>
        <div class="input-group" id="mcScrambleModeGroup" style="display:none">
          <label>Scramble Distribution</label>
          <select id="mcScrambleMode">
            <option value="gaussian" selected>Gaussian</option>
            <option value="uniform">Uniform</option>
            <option value="chaos">Deterministic Chaos</option>
          </select>
        </div>
        <div class="input-group" id="mcIntensityGroup" style="display:none">
          <label>Intensity <span id="lbMcIntensity">30%</span></label>
          <input type="range" id="mcIntensity" min="1" max="100" value="30">
        </div>
        <div class="mc-scramble-checks" id="mcScrambleChecks" style="display:none">
          <div class="section-label" style="font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--blue);margin:6px 0 4px">Scramble Parameters</div>
          <label class="mc-check"><input type="checkbox" id="mcScrVol" checked> Volatility</label>
          <label class="mc-check"><input type="checkbox" id="mcScrDrift" checked> Drift</label>
          <label class="mc-check"><input type="checkbox" id="mcScrRegime"> Regime Transitions</label>
          <label class="mc-check"><input type="checkbox" id="mcScrFee" checked> Fee %</label>
          <label class="mc-check"><input type="checkbox" id="mcScrSlip" checked> Slippage %</label>
          <label class="mc-check"><input type="checkbox" id="mcScrSpread"> Spread</label>
          <label class="mc-check"><input type="checkbox" id="mcScrMaint"> Maintenance Margin</label>
          <label class="mc-check"><input type="checkbox" id="mcScrLev"> Leverage</label>
          <label class="mc-check"><input type="checkbox" id="mcScrSize"> Position Size Mult.</label>
        </div>
        <div class="toggle-row" style="margin-bottom:8px;margin-top:8px">
          <span>Overlay Equity Curves</span>
          <label class="toggle"><input type="checkbox" id="mcOverlay"><span class="toggle-slider"></span></label>
        </div>
        <button class="btn btn-purple btn-sm" id="btnMC" style="width:100%;margin-bottom:4px">&#9654; RUN MONTE CARLO</button>
        <div id="mcProgress" style="display:none;margin-bottom:4px">
          <div class="mc-progress-bar"><div class="mc-progress-fill" id="mcProgressFill"></div></div>
          <span id="mcProgressText" style="font-size:9px;color:var(--muted)"></span>
        </div>
        <div style="display:flex;gap:6px;margin-bottom:8px">
          <button class="btn btn-ghost btn-sm" id="btnMcExportCsv" disabled>&#8595; CSV</button>
          <button class="btn btn-ghost btn-sm" id="btnMcExportJson" disabled>&#8595; JSON</button>
        </div>
        <div class="mc-results" id="mcResults"></div>
      </div>
    </div>
  </aside>
</div>

<!-- MOBILE TAB BAR -->
<nav class="mobile-tabs" id="mobileTabs">
  <button class="mob-tab active" data-tab="chart">Chart</button>
  <button class="mob-tab" data-tab="trading">Trading</button>
  <button class="mob-tab" data-tab="montecarlo">Monte Carlo</button>
  <button class="mob-tab" data-tab="performance">Performance</button>
</nav>

<!-- EXPORT MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-title">Exportoi markkinadata</div>
    <div class="modal-sub" id="modalSub">—</div>
    <div class="export-opts">
      <div class="exp-opt sel" id="optXlsx" data-fmt="xlsx">
        <div class="exp-icon">&#128202;</div>
        <div class="exp-title">Excel (.xlsx)</div>
        <div class="exp-desc">OHLCV-data + regiimitilastot kahdella välilehdellä.</div>
      </div>
      <div class="exp-opt" id="optJson" data-fmt="json">
        <div class="exp-icon">{ }</div>
        <div class="exp-title">JSON</div>
        <div class="exp-desc">Täydellinen raakadata ohjelmalliseen käyttöön.</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" id="btnModalCancel">Peruuta</button>
      <button class="btn btn-green" id="btnModalExport">&#8595; Lataa tiedosto</button>
    </div>
  </div>
</div>

<script type="module" src="js/main.js"></script>
</body>
</html>
