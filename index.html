<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Backtest Engine â€” Live Market Simulator</title>
<link rel="stylesheet" href="css/styles.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
<div class="shell" id="shell">

  <header class="topbar">
    <div class="logo">
      <div class="logo-dot" id="dot"></div>
      BACKTEST ENGINE
      <span class="logo-sub">// Live Simulator</span>
    </div>
    <div class="vdiv desktop-only"></div>
    <div class="ticker desktop-only">
      <div class="tick-item"><span class="tick-label">PRICE</span>  <span class="tick-val" id="tkP">â€”</span></div>
      <div class="tick-item"><span class="tick-label">CHG</span>    <span class="tick-val" id="tkC">â€”</span></div>
      <div class="tick-item"><span class="tick-label">HIGH</span>   <span class="tick-val" id="tkH">â€”</span></div>
      <div class="tick-item"><span class="tick-label">LOW</span>    <span class="tick-val" id="tkL">â€”</span></div>
      <div class="tick-item"><span class="tick-label">VOL</span>    <span class="tick-val" id="tkV">â€”</span></div>
      <div class="tick-item"><span class="tick-label">REGIME</span> <span class="tick-val" id="tkR">â€”</span></div>
      <div class="tick-item"><span class="tick-label">EQUITY</span> <span class="tick-val" id="tkEq">â€”</span></div>
    </div>
    <div class="topbar-right">
      <button class="btn btn-green" id="btnStart">&#9654; START</button>
      <button class="btn btn-yellow" id="btnPause" disabled>&#9208; PAUSE</button>
      <button class="btn btn-red" id="btnStop" disabled>&#9632; STOP</button>
      <div class="vdiv desktop-only"></div>
      <button class="btn btn-ghost" id="btnReset" data-mobile="secondary">&#10227; RESET</button>
    </div>
  </header>

  <!-- LEFT SIDEBAR -->
  <aside class="sidebar" id="sidebarLeft">
    <!-- Tab navigation for left sidebar -->
    <div class="sidebar-tabs">
      <button class="sidebar-tab active" data-panel="panelLiveSession">Live</button>
      <button class="sidebar-tab" data-panel="panelDataSource">Data</button>
      <button class="sidebar-tab" data-panel="panelOptimizer">Optimizer</button>
      <button class="sidebar-tab" data-panel="panelAnalysis">Analysis</button>
    </div>

    <!-- Live Session Tab -->
    <div class="sidebar-panel active" id="panelLiveSession">
      <div class="panel">
        <div class="panel-title">Live Session</div>
        <div class="live-counter">
          <span class="lc-label">Candles saved</span>
          <span class="lc-val" id="liveCount">0</span>
        </div>
        <div class="panel-title" style="margin-bottom:6px">Speed</div>
        <div class="speed-grid" id="speedGrid">
          <div class="speed-btn" data-ms="2000">0.5Ã—</div>
          <div class="speed-btn active" data-ms="800">1Ã—</div>
          <div class="speed-btn" data-ms="250">3Ã—</div>
          <div class="speed-btn" data-ms="60">15Ã—</div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">Parameters</div>
        <div class="control">
          <label title="Start price for the synthetic market.">Start Price <span id="lbS">10 000</span></label>
          <input type="range" id="rS" min="100" max="100000" step="100" value="10000">
        </div>
        <div class="control">
          <label title="Base volatility (%). Defines candle price movement magnitude.">Volatility <span id="lbV">1.5%</span></label>
          <input type="range" id="rV" min="0.3" max="5" step="0.1" value="1.5">
        </div>
        <div class="control">
          <label title="Trend bias adds directional weight to every candle.">Trend Bias <span id="lbB">0.00%</span></label>
          <input type="range" id="rB" min="-0.5" max="0.5" step="0.01" value="0">
        </div>
        <div class="control">
          <label title="Regime switch probability (%). Low = longer regimes, high = frequent switches.">Regime Switch <span id="lbSw">8%</span></label>
          <input type="range" id="rSw" min="1" max="30" step="1" value="8">
        </div>
        <div class="control">
          <label title="RNG seed. Same seed = identical price path.">Seed <span id="lbSd">42</span></label>
          <input type="range" id="rSd" min="1" max="99999" step="1" value="42">
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">Regimes</div>
        <div class="regime-list">
          <div class="regime-item" id="ri-bull">     <div class="regime-dot" style="background:#26de81"></div><span class="regime-name">Bull Trend</span>  <span class="regime-pct" id="pct-bull">â€”</span></div>
          <div class="regime-item" id="ri-bear">     <div class="regime-dot" style="background:#fc5c65"></div><span class="regime-name">Bear Trend</span>  <span class="regime-pct" id="pct-bear">â€”</span></div>
          <div class="regime-item" id="ri-sideways"> <div class="regime-dot" style="background:#45aaf2"></div><span class="regime-name">Sideways</span>     <span class="regime-pct" id="pct-sideways">â€”</span></div>
          <div class="regime-item" id="ri-swing">    <div class="regime-dot" style="background:#fed330"></div><span class="regime-name">Swing</span>        <span class="regime-pct" id="pct-swing">â€”</span></div>
          <div class="regime-item" id="ri-breakout"> <div class="regime-dot" style="background:#fd9644"></div><span class="regime-name">Breakout</span>     <span class="regime-pct" id="pct-breakout">â€”</span></div>
          <div class="regime-item" id="ri-crash">    <div class="regime-dot" style="background:#a55eea"></div><span class="regime-name">Flash Crash</span> <span class="regime-pct" id="pct-crash">â€”</span></div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">Statistics</div>
        <div class="stats-grid">
          <div class="stat"><div class="stat-label">Start</div>       <div class="stat-value neu" id="stS">â€”</div></div>
          <div class="stat"><div class="stat-label">Current</div>     <div class="stat-value" id="stN">â€”</div></div>
          <div class="stat"><div class="stat-label">High</div>        <div class="stat-value up" id="stH">â€”</div></div>
          <div class="stat"><div class="stat-label">Low</div>         <div class="stat-value down" id="stL">â€”</div></div>
          <div class="stat"><div class="stat-label">Max Drawdown</div><div class="stat-value down" id="stDD">â€”</div></div>
          <div class="stat"><div class="stat-label">Return</div>      <div class="stat-value" id="stRt">â€”</div></div>
        </div>
      </div>
    </div>

    <!-- Data Source Tab -->
    <div class="sidebar-panel" id="panelDataSource">
      <div class="panel">
        <div class="panel-title">Real Market Data</div>
        <div class="input-group">
          <label>Data Source</label>
          <select id="dataSource">
            <option value="synthetic">Synthetic (default)</option>
            <option value="binance">Binance</option>
            <option value="coingecko">CoinGecko</option>
          </select>
        </div>
        <div id="binanceOptions" style="display:none">
          <div class="input-group">
            <label>Symbol</label>
            <select id="dataSymbol">
              <option value="BTCUSDT">BTC/USDT</option>
              <option value="ETHUSDT">ETH/USDT</option>
              <option value="SOLUSDT">SOL/USDT</option>
              <option value="BNBUSDT">BNB/USDT</option>
              <option value="XRPUSDT">XRP/USDT</option>
              <option value="ADAUSDT">ADA/USDT</option>
              <option value="DOGEUSDT">DOGE/USDT</option>
              <option value="DOTUSDT">DOT/USDT</option>
              <option value="AVAXUSDT">AVAX/USDT</option>
              <option value="LINKUSDT">LINK/USDT</option>
            </select>
          </div>
          <div class="input-group">
            <label>Candles</label>
            <input type="number" id="dataLimit" value="500" min="50" max="1000">
          </div>
        </div>
        <div id="coingeckoOptions" style="display:none">
          <div class="input-group">
            <label>Coin</label>
            <select id="dataCoin">
              <option value="bitcoin">Bitcoin</option>
              <option value="ethereum">Ethereum</option>
              <option value="solana">Solana</option>
              <option value="binancecoin">BNB</option>
              <option value="ripple">XRP</option>
            </select>
          </div>
          <div class="input-group">
            <label>Days</label>
            <select id="dataDays">
              <option value="7">7 days</option>
              <option value="30">30 days</option>
              <option value="90" selected>90 days</option>
              <option value="180">180 days</option>
              <option value="365">365 days</option>
            </select>
          </div>
        </div>
        <button class="btn btn-blue btn-sm" id="btnFetchData" style="width:100%;margin-top:8px">Fetch Data</button>
        <div class="data-status" id="dataStatus" style="font-size:10px;color:var(--muted);margin-top:4px"></div>
      </div>

      <div class="panel">
        <div class="panel-title">Data Scrambling</div>
        <p style="font-size:10px;color:var(--muted);margin-bottom:8px">Shuffle price movements while preserving start and end prices. Useful for testing strategy robustness.</p>
        <div class="input-group">
          <label>Scramble Seed</label>
          <input type="number" id="scrambleSeed" value="1" min="1" max="99999">
        </div>
        <button class="btn btn-orange btn-sm" id="btnScramble" style="width:100%" disabled>Scramble Loaded Data</button>
      </div>
    </div>

    <!-- Optimizer Tab -->
    <div class="sidebar-panel" id="panelOptimizer">
      <div class="panel">
        <div class="panel-title">Parameter Optimizer</div>
        <div class="input-group">
          <label>Optimization Mode</label>
          <select id="optMode">
            <option value="grid">Grid Search</option>
            <option value="genetic">Genetic Algorithm</option>
          </select>
        </div>
        <div class="input-group">
          <label>Objective</label>
          <select id="optObjective">
            <option value="compositeScore">Composite Score</option>
            <option value="sharpe">Sharpe Ratio</option>
            <option value="totalReturn">Total Return</option>
            <option value="profitFactor">Profit Factor</option>
            <option value="calmar">Calmar Ratio</option>
          </select>
        </div>
        <div class="input-group">
          <label>Candles per Run</label>
          <input type="number" id="optCandles" value="500" min="50" max="5000" step="50">
        </div>
        <div id="geneticOptions" style="display:none">
          <div class="input-row">
            <div class="input-group"><label>Population</label><input type="number" id="optPopulation" value="20" min="5" max="100"></div>
            <div class="input-group"><label>Generations</label><input type="number" id="optGenerations" value="10" min="2" max="50"></div>
          </div>
          <div class="input-group"><label>Mutation Rate</label><input type="number" id="optMutation" value="0.2" min="0.01" max="1" step="0.05"></div>
        </div>
        <div class="section-label" style="font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--blue);margin:8px 0 4px">Parameter Ranges</div>
        <div id="optParamRanges" style="font-size:10px;color:var(--muted)">Load a strategy with params to configure ranges</div>
        <button class="btn btn-purple btn-sm" id="btnOptimize" style="width:100%;margin-top:8px" disabled>Run Optimizer</button>
        <div id="optProgress" style="display:none;margin-top:4px">
          <div class="mc-progress-bar"><div class="mc-progress-fill" id="optProgressFill"></div></div>
          <span id="optProgressText" style="font-size:9px;color:var(--muted)"></span>
        </div>
        <div id="optResults" style="margin-top:8px"></div>
      </div>
    </div>

    <!-- Analysis Tab -->
    <div class="sidebar-panel" id="panelAnalysis">
      <div class="panel">
        <div class="panel-title">Walk-Forward Analysis</div>
        <div class="input-row">
          <div class="input-group"><label>Total Candles</label><input type="number" id="wfCandles" value="2000" min="200" max="10000" step="100"></div>
          <div class="input-group"><label>Window Size</label><input type="number" id="wfWindow" value="500" min="50" max="5000" step="50"></div>
        </div>
        <div class="input-row">
          <div class="input-group"><label>OOS Size</label><input type="number" id="wfOos" value="100" min="20" max="1000" step="10"></div>
          <div class="input-group"><label>Step Size</label><input type="number" id="wfStep" value="100" min="10" max="500" step="10"></div>
        </div>
        <button class="btn btn-blue btn-sm" id="btnWalkForward" style="width:100%;margin-top:4px">Run Walk-Forward</button>
        <div id="wfProgress" style="display:none;margin-top:4px">
          <div class="mc-progress-bar"><div class="mc-progress-fill" id="wfProgressFill"></div></div>
          <span id="wfProgressText" style="font-size:9px;color:var(--muted)"></span>
        </div>
        <div id="wfResults" style="margin-top:8px"></div>
      </div>

      <div class="panel">
        <div class="panel-title">Saved Runs</div>
        <div id="savedRuns" style="font-size:10px;color:var(--muted)">No saved runs</div>
        <div style="display:flex;gap:4px;margin-top:8px">
          <button class="btn btn-blue btn-sm" id="btnSaveRun" disabled>Save Current</button>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">Indicator Plugins</div>
        <div class="input-group">
          <label>Add Indicator</label>
          <select id="pluginIndicator">
            <option value="">Select...</option>
          </select>
        </div>
        <div id="activePlugins" style="margin-top:4px"></div>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main" id="mainArea">
    <div class="chart-toolbar">
      <span class="pair-badge" id="pairBadge">BTC/USDT</span>
      <span class="live-badge" id="liveBadge">LIVE</span>
      <div class="tf-group">
      </div>
      <div class="ind-legend" id="indLegend"></div>
      <span class="chart-hint desktop-only">Scroll = pan Â· Ctrl+Scroll = zoom Â· Drag = pan</span>
    </div>

    <div class="chart-area">
      <canvas id="cc"></canvas>
      <div class="nc-flash" id="ncf"></div>
      <div class="tooltip-box" id="tooltip">
        <div class="tt-row"><span class="tt-key">Bar</span>    <span class="tt-val" id="tta">â€”</span></div>
        <div class="tt-row"><span class="tt-key">Open</span>   <span class="tt-val" id="tto">â€”</span></div>
        <div class="tt-row"><span class="tt-key">High</span>   <span class="tt-val" id="tth">â€”</span></div>
        <div class="tt-row"><span class="tt-key">Low</span>    <span class="tt-val" id="ttl">â€”</span></div>
        <div class="tt-row"><span class="tt-key">Close</span>  <span class="tt-val" id="ttc">â€”</span></div>
        <div class="tt-row"><span class="tt-key">Chg%</span>   <span class="tt-val" id="ttchg">â€”</span></div>
        <div class="tt-row"><span class="tt-key">Volume</span> <span class="tt-val" id="ttv">â€”</span></div>
        <div class="tt-row"><span class="tt-key">Regime</span> <span class="tt-val" id="ttr">â€”</span></div>
      </div>
    </div>

    <div class="equity-area" id="eqArea" style="display:none">
      <canvas id="eqc"></canvas>
    </div>

    <!-- Heatmap Canvas -->
    <div class="heatmap-area" id="heatmapArea" style="display:none">
      <canvas id="heatmapCanvas"></canvas>
      <div class="heatmap-legend" id="heatmapLegend"></div>
    </div>

    <div class="timeline-area">
      <div class="tl-label">Regime Timeline</div>
      <div class="timeline-bar" id="tlBar"></div>
    </div>

    <div class="export-bar">
      <span class="export-info" id="expInfo">Press <strong>&#9654; START</strong> to begin live data recording.</span>
      <button class="btn btn-blue btn-sm" id="btnExportTrades" disabled>&#8595; TRADES CSV</button>
      <button class="btn btn-blue btn-sm" id="btnReport" disabled>&#8595; REPORT</button>
      <button class="btn btn-blue" id="btnExport" disabled>&#8595; EXPORT DATA</button>
    </div>
  </main>

  <!-- RIGHT SIDEBAR -->
  <aside class="sidebar-right" id="sidebarRight">
    <!-- Tab navigation for right sidebar -->
    <div class="sidebar-tabs">
      <button class="sidebar-tab active" data-panel="panelTradingTab">Trading</button>
      <button class="sidebar-tab" data-panel="panelPerfTab">Performance</button>
      <button class="sidebar-tab" data-panel="panelMonteCarloTab">Monte Carlo</button>
    </div>

    <!-- Trading Tab -->
    <div class="sidebar-panel active" id="panelTradingTab">
      <div class="panel">
        <div class="panel-title">Trading Mode</div>
        <div class="input-row">
          <div class="input-group">
            <label>Mode</label>
            <select id="tMode">
              <option value="spot">Spot</option>
              <option value="futures" selected>Futures (Isolated)</option>
            </select>
          </div>
          <div class="input-group">
            <label>Leverage</label>
            <select id="tLev">
              <option value="1">1Ã—</option><option value="2">2Ã—</option><option value="3">3Ã—</option>
              <option value="5">5Ã—</option><option value="10" selected>10Ã—</option><option value="20">20Ã—</option>
              <option value="25">25Ã—</option><option value="40">40Ã—</option>
            </select>
          </div>
        </div>
        <div class="input-row">
          <div class="input-group"><label>Maker Fee %</label><input type="number" id="tMakerFee" value="0.02" step="0.001" min="0"></div>
          <div class="input-group"><label>Taker Fee %</label><input type="number" id="tTakerFee" value="0.04" step="0.001" min="0"></div>
        </div>
        <div class="input-row">
          <div class="input-group"><label>Slippage %</label><input type="number" id="tSlippage" value="0.05" step="0.01" min="0"></div>
          <div class="input-group"><label>Maint. Rate %</label><input type="number" id="tMaintRate" value="0.5" step="0.1" min="0"></div>
        </div>
        <div class="toggle-row" style="margin:6px 0">
          <span>Market Impact Model</span>
          <label class="toggle"><input type="checkbox" id="tMarketImpact" checked><span class="toggle-slider"></span></label>
        </div>
        <div class="input-row">
          <div class="input-group"><label>Starting Balance</label><input type="number" id="tBalance" value="10000" step="100" min="100"></div>
          <div class="input-group"><label>Position Sizing</label>
            <select id="tSizeMode"><option value="fixed">Fixed Amount</option><option value="percent">% of Equity</option></select>
          </div>
        </div>
        <div class="input-group"><label>Size Value</label><input type="number" id="tSizeVal" value="1000" step="100" min="1"></div>
        <div class="input-row" style="margin-top:4px">
          <div class="input-group"><label>Stop Loss %</label><input type="number" id="tSL" value="2" step="0.1" min="0"></div>
          <div class="input-group"><label>Take Profit %</label><input type="number" id="tTP" value="4" step="0.1" min="0"></div>
        </div>
        <div class="input-group"><label>Trailing Stop %</label><input type="number" id="tTrail" value="0" step="0.1" min="0"></div>
        <div class="input-group"><label>Partial Fill %</label><input type="number" id="tPartialFill" value="100" step="5" min="5" max="100"></div>
        <div class="trade-btns" id="manualTradeBtns">
          <button class="btn btn-green btn-sm" id="btnManualBuy">&#9650; BUY/LONG</button>
          <button class="btn btn-red btn-sm" id="btnManualSell">&#9660; SELL/SHORT</button>
        </div>
        <div class="trade-blocked" id="tradeBlockedMsg">Manual trading disabled while strategy is active</div>
      </div>

      <!-- Strategy Engine -->
      <div class="panel panel-collapse open" id="panelStrategy">
        <div class="panel-title">Strategy Engine</div>
        <div class="panel-body" id="strategyBody">
          <div class="toggle-row" style="margin-bottom:8px">
            <span>Enable Strategy</span>
            <label class="toggle"><input type="checkbox" id="tStratEnabled"><span class="toggle-slider"></span></label>
          </div>
          <div class="input-group">
            <label>Select Strategy</label>
            <select id="tStratSelect">
              <option value="custom">Custom (paste code)</option>
            </select>
          </div>
          <div id="stratParamsContainer"></div>
          <div class="input-group" style="margin-top:8px">
            <label>Strategy Code (JS)</label>
            <textarea id="tStratCode" rows="6" placeholder="// Select a preset strategy or paste custom code"></textarea>
          </div>
          <div style="display:flex;gap:6px">
            <button class="btn btn-blue btn-sm" id="btnLoadStrat">Load Strategy</button>
            <label class="btn btn-ghost btn-sm" style="display:inline-flex;align-items:center;cursor:pointer">
              Upload File <input type="file" accept=".js,.txt" style="display:none" id="btnUploadStrat">
            </label>
          </div>
          <div class="strat-error" id="stratError"></div>
        </div>
      </div>

      <!-- Positions -->
      <div class="panel panel-collapse open" id="panelPositions">
        <div class="panel-title">Open Positions <span id="posCount" style="color:var(--blue)">(0)</span></div>
        <div class="panel-body" id="positionsBody">
          <div class="pos-list" id="posList"></div>
        </div>
      </div>
    </div>

    <!-- Performance Tab -->
    <div class="sidebar-panel" id="panelPerfTab">
      <!-- Performance -->
      <div class="panel" id="panelPerformance">
        <div class="panel-title">Performance Metrics</div>
        <div class="stats-grid" id="perfGrid">
          <div class="stat"><div class="stat-label">Balance</div><div class="stat-value sm neu" id="pmBal">â€”</div></div>
          <div class="stat"><div class="stat-label">Equity</div><div class="stat-value sm neu" id="pmEq">â€”</div></div>
          <div class="stat"><div class="stat-label">Unreal. PnL</div><div class="stat-value sm" id="pmUPnl">â€”</div></div>
          <div class="stat"><div class="stat-label">Real. PnL</div><div class="stat-value sm" id="pmRPnl">â€”</div></div>
          <div class="stat"><div class="stat-label">Win Rate</div><div class="stat-value sm" id="pmWR">â€”</div></div>
          <div class="stat"><div class="stat-label">Profit Factor</div><div class="stat-value sm" id="pmPF">â€”</div></div>
          <div class="stat"><div class="stat-label">Sharpe</div><div class="stat-value sm" id="pmSh">â€”</div></div>
          <div class="stat"><div class="stat-label">Sortino</div><div class="stat-value sm" id="pmSortino">â€”</div></div>
          <div class="stat"><div class="stat-label">Max DD</div><div class="stat-value sm down" id="pmDD">â€”</div></div>
          <div class="stat"><div class="stat-label">Expectancy</div><div class="stat-value sm" id="pmExp">â€”</div></div>
          <div class="stat"><div class="stat-label">Kelly %</div><div class="stat-value sm" id="pmKe">â€”</div></div>
          <div class="stat"><div class="stat-label">Avg R</div><div class="stat-value sm" id="pmAvgR">â€”</div></div>
          <div class="stat"><div class="stat-label">Max Consec Loss</div><div class="stat-value sm down" id="pmMCL">â€”</div></div>
          <div class="stat"><div class="stat-label">Exposure %</div><div class="stat-value sm" id="pmExpo">â€”</div></div>
          <div class="stat"><div class="stat-label">Total Fees</div><div class="stat-value sm down" id="pmFees">â€”</div></div>
          <div class="stat"><div class="stat-label">CAGR</div><div class="stat-value sm" id="pmCAGR">â€”</div></div>
        </div>
      </div>

      <!-- Risk Metrics -->
      <div class="panel panel-collapse" id="panelRisk">
        <div class="panel-title">Risk Metrics</div>
        <div class="panel-body">
          <div class="stats-grid">
            <div class="stat"><div class="stat-label">VaR 95%</div><div class="stat-value sm" id="pmVaR95">â€”</div></div>
            <div class="stat"><div class="stat-label">CVaR 95%</div><div class="stat-value sm" id="pmCVaR">â€”</div></div>
            <div class="stat"><div class="stat-label">Omega</div><div class="stat-value sm" id="pmOmega">â€”</div></div>
            <div class="stat"><div class="stat-label">MAR</div><div class="stat-value sm" id="pmMAR">â€”</div></div>
            <div class="stat"><div class="stat-label">Calmar</div><div class="stat-value sm" id="pmCalmar">â€”</div></div>
            <div class="stat"><div class="stat-label">Treynor</div><div class="stat-value sm" id="pmTreynor">â€”</div></div>
          </div>
          <div class="help-text" style="margin-top:8px">
            <div class="help-item"><strong>VaR 95%:</strong> Maximum expected daily loss with 95% confidence. <span class="badge-inline down">Below -3% = high risk</span></div>
            <div class="help-item"><strong>CVaR:</strong> Average loss when VaR is exceeded (tail risk).</div>
            <div class="help-item"><strong>Omega:</strong> Ratio of gains to losses. <span class="badge-inline up">Above 1.5 = strong</span></div>
            <div class="help-item"><strong>MAR/Calmar:</strong> CAGR / Max Drawdown. <span class="badge-inline up">Above 1.0 = excellent</span></div>
          </div>
        </div>
      </div>

      <!-- Benchmark -->
      <div class="panel panel-collapse" id="panelBenchmark">
        <div class="panel-title">Benchmark: Buy & Hold</div>
        <div class="panel-body">
          <div class="stats-grid">
            <div class="stat"><div class="stat-label">B&H Return</div><div class="stat-value sm" id="bmReturn">â€”</div></div>
            <div class="stat"><div class="stat-label">B&H Sharpe</div><div class="stat-value sm" id="bmSharpe">â€”</div></div>
            <div class="stat"><div class="stat-label">B&H Max DD</div><div class="stat-value sm" id="bmDD">â€”</div></div>
            <div class="stat"><div class="stat-label">Alpha</div><div class="stat-value sm" id="bmAlpha">â€”</div></div>
          </div>
        </div>
      </div>

      <!-- Trade Log -->
      <div class="panel panel-collapse" id="panelTradeLog">
        <div class="panel-title">Trade Log <span id="tradeCount" style="color:var(--blue)">(0)</span></div>
        <div class="panel-body" id="tradeLogBody">
          <div class="trade-log" id="tradeLog"></div>
        </div>
      </div>

      <!-- Trade Breakdown -->
      <div class="panel panel-collapse" id="panelTradeBreakdown">
        <div class="panel-title">Trade Breakdown</div>
        <div class="panel-body">
          <div id="tradeBreakdown" style="max-height:300px;overflow-y:auto;font-size:10px"></div>
        </div>
      </div>
    </div>

    <!-- Monte Carlo Tab -->
    <div class="sidebar-panel" id="panelMonteCarloTab">
      <div class="panel" id="panelMonteCarlo">
        <div class="panel-title">Monte Carlo</div>
        <div class="input-row">
          <div class="input-group"><label>Runs</label><input type="number" id="mcRuns" value="50" step="10" min="5" max="500"></div>
          <div class="input-group"><label>Candles/Run</label><input type="number" id="mcCandles" value="500" step="50" min="50" max="5000"></div>
        </div>
        <div class="input-group">
          <label>MC Mode</label>
          <select id="mcMode">
            <option value="seed">Seed Only</option>
            <option value="scramble">Parameter Scramble</option>
            <option value="combined">Combined Chaos</option>
            <option value="stress">Stress Test</option>
          </select>
        </div>
        <div class="input-group" id="mcChaosPresetGroup" style="display:none">
          <label>Chaos Preset</label>
          <select id="mcChaosPreset">
            <option value="low">Low</option>
            <option value="medium" selected>Medium</option>
            <option value="extreme">Extreme</option>
          </select>
        </div>
        <div class="input-group" id="mcScrambleModeGroup" style="display:none">
          <label>Scramble Distribution</label>
          <select id="mcScrambleMode">
            <option value="gaussian" selected>Gaussian</option>
            <option value="uniform">Uniform</option>
            <option value="chaos">Deterministic Chaos</option>
          </select>
        </div>
        <div class="input-group" id="mcIntensityGroup" style="display:none">
          <label>Intensity <span id="lbMcIntensity">30%</span></label>
          <input type="range" id="mcIntensity" min="1" max="100" value="30">
        </div>
        <div class="mc-scramble-checks" id="mcScrambleChecks" style="display:none">
          <div class="section-label" style="font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--blue);margin:6px 0 4px">Scramble Parameters</div>
          <label class="mc-check"><input type="checkbox" id="mcScrVol" checked> Volatility</label>
          <label class="mc-check"><input type="checkbox" id="mcScrDrift" checked> Drift</label>
          <label class="mc-check"><input type="checkbox" id="mcScrRegime"> Regime Transitions</label>
          <label class="mc-check"><input type="checkbox" id="mcScrFee" checked> Fee %</label>
          <label class="mc-check"><input type="checkbox" id="mcScrSlip" checked> Slippage %</label>
          <label class="mc-check"><input type="checkbox" id="mcScrSpread"> Spread</label>
          <label class="mc-check"><input type="checkbox" id="mcScrMaint"> Maintenance Margin</label>
          <label class="mc-check"><input type="checkbox" id="mcScrLev"> Leverage</label>
          <label class="mc-check"><input type="checkbox" id="mcScrSize"> Position Size Mult.</label>
        </div>
        <div class="toggle-row" style="margin-bottom:8px;margin-top:8px">
          <span>Overlay Equity Curves</span>
          <label class="toggle"><input type="checkbox" id="mcOverlay"><span class="toggle-slider"></span></label>
        </div>
        <button class="btn btn-purple btn-sm" id="btnMC" style="width:100%;margin-bottom:4px">&#9654; RUN MONTE CARLO</button>
        <div id="mcProgress" style="display:none;margin-bottom:4px">
          <div class="mc-progress-bar"><div class="mc-progress-fill" id="mcProgressFill"></div></div>
          <span id="mcProgressText" style="font-size:9px;color:var(--muted)"></span>
        </div>
        <div style="display:flex;gap:6px;margin-bottom:8px">
          <button class="btn btn-ghost btn-sm" id="btnMcExportCsv" disabled>&#8595; CSV</button>
          <button class="btn btn-ghost btn-sm" id="btnMcExportJson" disabled>&#8595; JSON</button>
        </div>
        <div class="mc-results" id="mcResults"></div>
      </div>
    </div>
  </aside>
</div>

<!-- MOBILE TAB BAR -->
<nav class="mobile-tabs" id="mobileTabs">
  <button class="mob-tab active" data-tab="chart"><span class="mob-ic">ðŸ“ˆ</span><span class="mob-label">Chart</span></button>
  <button class="mob-tab" data-tab="trading"><span class="mob-ic">ðŸ’¼</span><span class="mob-label">Trading</span></button>
  <button class="mob-tab" data-tab="montecarlo"><span class="mob-ic">ðŸŽ²</span><span class="mob-label">Monte Carlo</span></button>
  <button class="mob-tab" data-tab="performance"><span class="mob-ic">ðŸ“Š</span><span class="mob-label">Performance</span></button>
</nav>

<!-- EXPORT MODAL -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <div class="modal-title">Export Market Data</div>
    <div class="modal-sub" id="modalSub">â€”</div>
    <div class="export-opts">
      <div class="exp-opt sel" id="optXlsx" data-fmt="xlsx">
        <div class="exp-icon">&#128202;</div>
        <div class="exp-title">Excel (.xlsx)</div>
        <div class="exp-desc">OHLCV data + regime stats in two sheets.</div>
      </div>
      <div class="exp-opt" id="optJson" data-fmt="json">
        <div class="exp-icon">{ }</div>
        <div class="exp-title">JSON</div>
        <div class="exp-desc">Full raw data for programmatic use.</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-ghost" id="btnModalCancel">Cancel</button>
      <button class="btn btn-green" id="btnModalExport">&#8595; Download</button>
    </div>
  </div>
</div>

<!-- TUTORIAL MODAL -->
<div class="modal-overlay" id="tutorialModal">
  <div class="modal" style="width:600px;max-height:80vh;overflow-y:auto">
    <div class="modal-title">Getting Started</div>
    <div class="tutorial-content" id="tutorialContent">
      <div class="tutorial-step">
        <h3 style="color:var(--green);margin-bottom:6px">1. Run a Simulation</h3>
        <p>Click <strong>START</strong> to begin generating synthetic market data. Adjust <strong>volatility</strong>, <strong>trend bias</strong>, and <strong>seed</strong> in the left sidebar to change market conditions.</p>
      </div>
      <div class="tutorial-step">
        <h3 style="color:var(--blue);margin-bottom:6px">2. Enable a Strategy</h3>
        <p>Toggle <strong>Enable Strategy</strong> in the Trading tab. Select a preset strategy or paste custom code. Click <strong>Load Strategy</strong> to activate it.</p>
      </div>
      <div class="tutorial-step">
        <h3 style="color:var(--purple);margin-bottom:6px">3. Monte Carlo Analysis</h3>
        <p>Use the <strong>Monte Carlo</strong> tab to stress-test your strategy across many randomized market scenarios. Check <strong>Overlay Equity Curves</strong> to visualize all runs.</p>
      </div>
      <div class="tutorial-step">
        <h3 style="color:var(--orange);margin-bottom:6px">4. Real Market Data</h3>
        <p>Switch to the <strong>Data</strong> tab in the left sidebar. Select <strong>Binance</strong> or <strong>CoinGecko</strong> as data source to backtest on real crypto prices.</p>
      </div>
      <div class="tutorial-step">
        <h3 style="color:var(--yellow);margin-bottom:6px">5. Parameter Optimization</h3>
        <p>Use the <strong>Optimizer</strong> tab to run grid search or genetic algorithm optimization on your strategy parameters.</p>
      </div>
      <div class="tutorial-step">
        <h3 style="color:var(--red);margin-bottom:6px">6. Walk-Forward Analysis</h3>
        <p>The <strong>Analysis</strong> tab provides walk-forward testing to validate strategy robustness with in-sample/out-of-sample windows.</p>
      </div>
      <div class="tutorial-step">
        <h3 style="color:var(--green);margin-bottom:6px">7. Risk & Performance</h3>
        <p>View advanced risk metrics (VaR, CVaR, Omega, Calmar) and Buy & Hold benchmark comparison in the <strong>Performance</strong> tab.</p>
      </div>
      <div class="tutorial-step">
        <h3 style="color:var(--blue);margin-bottom:6px">8. Export Reports</h3>
        <p>Generate HTML backtest reports, export trade CSVs, or download market data in Excel/JSON format.</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-green" id="btnCloseTutorial">Got it!</button>
    </div>
  </div>
</div>

<script type="module" src="js/main.js"></script>
</body>
</html>
